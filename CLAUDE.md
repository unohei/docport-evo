# DocPort-evo / CLAUDE.md

## 0. このファイルの目的

Claudeは、このプロジェクトでは本ファイルの方針を最優先する。
「過度な理想設計」より「安全に動くMVP」を優先する。

---

## 1. プロジェクトの目的と前提

DocPort-evoは、医療機関向けの安全なファイル共有システムのMVPである。

- 将来は有料SaaS化を前提とする（ただしMVPでは課金機能は実装しない）
- マルチテナント前提（病院単位でデータ分離）
- 医療用途のため監査ログは必要（ただし段階的に実装）

---

## 2. 技術スタック（固定）

- Frontend: React (Vite)
- Backend: FastAPI
- DB/Auth: Supabase（Auth + RLS）
- Storage: Cloudflare R2
- Deploy: Render

---

## 3. セキュリティと認可の基本方針（最重要）

### 3.1 RLSを主軸にする

- SupabaseのRLSを前提にアクセス制御を設計する。
- FastAPI側で認可ロジックを重複実装しない（必要な場合のみ最小限）。
- 常に「他病院データが見えない」を最優先する。

### 3.2 秘密情報の扱い

- service_roleキーは絶対にフロントに出さない。
- .env は絶対にコミットしない。

### 3.3 JWTの扱い

- JWTは「誰かを識別するためのトークン」。
- 実際のデータアクセス制御はRLSで担保する（責務混同しない）。

---

## 4. 監査ログ（段階戦略）

医療用途のため監査ログは将来的に必須。
ただしMVPでは「重要イベント」に絞って記録する（レベル1）。

### 4.1 MVPで記録するイベント（推奨）

- アップロード
- ダウンロード
- 削除
- 共有リンク作成・失効

※閲覧（プレビュー）ログは本番フェーズで検討する（負荷・コスト増になりやすい）。

---

## 5. 将来の有料SaaS化を見据えた方針

- MVPでは課金機能（決済/請求/解約/トライアル）は実装しない。
- ただしテナント（病院）単位でプラン概念を持てるように、データ設計は拡張可能にする。
  - 例：tenants に plan / status 等のカラムを置ける前提

---

## 6. API公開（未確定）

将来的に外部API公開の可能性はあるが、現時点では未確定。

- 現段階では「Webアプリ内部利用」を前提に進める。
- ただし、将来の拡張を妨げる破壊的な設計は避ける（例：URL設計の破綻、無秩序なエンドポイント命名）。
- 外部公開前提の要件（APIキー、レート制限、バージョニング強制など）はMVPでは実装しない。

---

## 7. アーキテクチャ方針（暴走防止）

- バックエンドは薄く保つ
- ビジネスロジックは最小限
- 可読性優先（読みやすさ > 賢さ）
- 早すぎる抽象化をしない
- マイクロサービス化しない
- DIコンテナ導入しない
- クラス過多のOOPに寄せない（関数型寄り）

---

## 8. ディレクトリ構造ルール

- /web : フロントエンド専用
- /api : FastAPI専用

責務を混在させない。

---

## 9. Claudeの出力ルール（超重要）

Claudeは以下を守ること：

- 差分ではなく「完成ファイル」を出力する（コピペで反映できる状態）
- 変更点がある場合は、ファイル内コメントで要点を明示する
- 不要な大改修・大規模リファクタ提案はしない
- 追加ライブラリ導入は必要最小限にする（導入理由も添える）

---

## 10. 現在のフェーズ

Phase: MVP安定化

優先事項：

- ファイル共有機能の安定化
- マルチテナント分離（RLS）の確認
- 監査ログ（重要イベント）の導入
- デプロイ安定化

スケーラビリティ最適化や過度な将来対応は行わない。

## 11. OCR（AI）機能の方針（MVP v1.5）

OCRは「送信前の確認支援」が目的。AIの判断で送信を確定しない。

### 11.1 OCRの対象タイミング

- 送信前（置く前）のPDFのみを対象にする
- Inbox/Sentの既存PDFに対する一括OCRはMVPではしない（コスト/負荷/監査が重い）

### 11.2 何を出すか（最小）

- 抽出テキスト
- メタ情報（例：患者ID、氏名、診療科、紹介元、日付など）※推定でOK
- 要配慮情報の“注意喚起”のみ（断定は禁止）
  - 例：「要配慮情報の可能性があります：病名、障害、検査結果 など」

### 11.3 人間確認が必須

- OCR結果は編集可能にし、最終確定はユーザーが行う
- 「置く」ボタンで確定（AIが自動送信しない）

### 11.4 データ保存方針（重要）

- MVPではOCRの全文保存を必須にしない（原則：必要最小限）
- 保存する場合も、RLSで病院単位に分離し、閲覧権限を明確化する
- OCR結果は「ドキュメントIDに紐づくメタ情報」として保存し、元PDFの代替にしない

### 11.5 セキュリティ（最重要）

- FastAPIでOCRを提供する場合も、Supabase JWTを検証し、RLSで許可されたdocのみ処理する
- service_roleの濫用は禁止（必要時のみ最小範囲で使用し理由を記載）

### 11.6 監査ログ（OCR分）

- OCR実行（OCR_RUN）
- OCR結果の確定（OCR_CONFIRM）
- OCR結果の破棄（OCR_DISCARD）
  ※全文テキストはログに入れない（要配慮情報リスク）

---

## 12. 自動承認モード運用ルール

Claudeは自動承認モードでの作業を許可する。
ただし以下を厳守すること。

### 12.1 変更範囲

- /web と /api のみ変更可
- Supabase RLSやDB構造は、SQL提案のみ（自動変更しない）
- Render / Cloudflare 設定は変更しない

### 12.2 変更単位

- 1タスク = 1機能に限定する
- 既存機能（置く / 受け取る / 記録 / プレビュー / 認証）を壊さない
- 大規模リファクタ禁止

### 12.3 出力ルール

- 差分ではなく「完成ファイル全文」で出力
- ファイル先頭に変更理由をコメントで明示する
- 変更点の要約（3行以内）を必ず付ける

### 12.4 セキュリティ制約

- service_roleキーは絶対にフロントに出さない
- 認可ロジックを緩める変更は禁止
- JWT / RLS周りの変更は慎重に行う

### 12.5 失敗時

- ビルドエラーが出る可能性がある変更は、ロールバック案も提示する

---

## 13. 現在のMVP到達点（現状把握）

### 13.1 できていること（MVP）

- 認証：Supabase Magic Linkログイン / ログアウト
- マルチテナント：Supabase RLSをON（病院単位でデータ分離）
- 置く：PDFドラッグ&ドロップでアップロード（R2へPresigned PUT）
- スキャン：ブラウザカメラ撮影→補正→PDF化→置く
- 受け取る：Inbox一覧（未読/既読/期限/取消/アーカイブの表示）
- 記録：Sent一覧（未読&期限内のみ取り消し可）
- プレビュー：アプリ内モーダルでPDFプレビュー＋「端末で開く」
- 監査ログ：document_events に重要イベント記録（UPLOAD/DOWNLOAD/ARCHIVE/CANCEL）
- デプロイ：Cloudflare Pages（web）＋ Render（api）

### 13.2 未実装（近々やりたい）

- OCR（v1.5）：送信前PDFのテキスト抽出＋メタ情報推定＋注意喚起（人間確定）
- PDF変換：Word/画像などの自動PDF化（現場の「PDF化できない」課題）
- 整理UI：病院別フォルダ表示 / 並び替え
- クリップ：お気に入り・あとで見る（カードにフラグ）
- 設定画面：ユーザー発行、病院アイコン差し替え等

### 13.3 既知のリスク（優先的に潰す）

- Presign APIの認可：FastAPI側でSupabase JWT検証＋対象docの権限確認が必要
- RLS前提の確認：documents / document_events / profiles のRLSが意図通りか定期確認
- プレビュー安定性：初回アクセス時のウォームアップ/タイムアウト対策が必要
